services:
  frontend:
    container_name: my-university-frontend
    build:
      context: ./my-university-frontend
      dockerfile: Dockerfile
      args:
        VITE_TENANT_API_BASE_URL: ${VITE_TENANT_API_BASE_URL:-http://host.docker.internal:5099}
        VITE_AUTH_API_BASE_URL: ${VITE_AUTH_API_BASE_URL:-http://host.docker.internal:5050}
        VITE_ADMIN_API_BASE_URL: ${VITE_ADMIN_API_BASE_URL:-http://host.docker.internal:5001}
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://host.docker.internal:5099}
        VITE_DEFAULT_AUTH_TOKEN: ${VITE_DEFAULT_AUTH_TOKEN:-}
    environment:
      TENANT_API_BASE_URL: ${TENANT_API_BASE_URL:-http://host.docker.internal:5099}
      AUTH_API_BASE_URL: ${AUTH_API_BASE_URL:-http://host.docker.internal:5050}
      ADMIN_API_BASE_URL: ${ADMIN_API_BASE_URL:-http://host.docker.internal:5001}
      DEFAULT_AUTH_TOKEN: ${DEFAULT_AUTH_TOKEN:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6Ijk3Njc4OTc3IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6IiIsImZpcnN0TmFtZSI6ItCh0LXRgNCz0LXQuSIsImxhc3ROYW1lIjoi0KfQtdGA0L3Ri9GI0ZHQsiIsImV4cCI6MTc2NTc3MDk0NywiaXNzIjoiTXlVbml2ZXJzaXR5IiwiYXVkIjoiTXlVbml2ZXJzaXR5VXNlcnMifQ.ul7fYPPsZctsVp5XLZrb04fJy32WVzDXMvVLHuHKzNY}
    ports:
      - "4173:80"
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - wget -qO- http://localhost/health || exit 1
      interval: 30s
      timeout: 5s
      retries: 3
  hacatonmax.webhost:
    image: hacatonmax.webhost
    build:
      context: .
      dockerfile: HacatonMax.WebHost/Dockerfile
    environment:
      "ConnectionStrings__Postgres": "User ID=postgres;Password=password;Host=db.university;Port=5434;Database=my-university"
      "MaxBot__AccessToken": ""
      "Elasticsearch__Uri": "http://elasticsearch:9200"
      "RabbitMq__Uri": "amqp://guest:guest@rabbitmq:5672/"
      "TenantSettings__UniversityName": "Центральный Университет"
      "TenantSettings__TenantName": "cu"
      "TenantSettings__TenantId": "1"
    ports:
      - "5099:5099"
    depends_on:
      db.university:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
  hacatonmax.admin:
    image: hacatonmax.admin
    build:
      context: .
      dockerfile: HacatonMax.Admin/Dockerfile
    environment:
      "ConnectionStrings__Postgres": "User ID=postgres;Password=password;Host=db.admin;Port=5433;Database=my-admin"
    ports:
      - "5001:5001"
    depends_on:
      - db.admin
  hacatonmax.auth:
    image: hacatonmax.auth
    build:
      context: .
      dockerfile: HacatonMax.Auth/Dockerfile
    environment:
      "MaxBot__AccessToken": ""
    ports:
      - "5050:5050"

  db.university:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_DB: my-university
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      PGPORT: 5434
    volumes:
      - db_data2:/var/lib/postgresql/data

  db.admin:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_DB: my-admin
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      PGPORT: 5433
    volumes:
      - db_data_admin:/var/lib/postgresql/data
  
  elasticsearch:
    image: elasticsearch:9.2.1
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.routing.allocation.disk.threshold_enabled=false
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.13-management
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "status" ]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  db_data2:
  db_data_admin:
  elasticsearch_data:
